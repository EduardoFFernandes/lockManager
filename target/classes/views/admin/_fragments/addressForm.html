<div xmlns:th="http://www.w3.org/1999/xhtml" th:fragment="addressForm">

	<input type="hidden" name="address.id" th:value="${object.address.id}" th:if="${object.id != null}"/>

	<div class="form-group">
		<label th:text="#{address}"></label>
		<input type="text" class="form-control" th:field="*{address.address}" data-parsley-maxlength="150" />
		<ul class="parsley-errors-list filled">
			<li class="parsley-required" th:errors="*{address.address}"></li>
		</ul>
	</div>

	<div class="form-row">
		<div class="form-group col-sm-4">
			<label th:text="#{city}"></label>
			<input type="text" class="form-control" th:field="*{address.city}" data-parsley-maxlength="50" />
			<ul class="parsley-errors-list filled">
				<li class="parsley-required" th:errors="*{address.city}"></li>
			</ul>
		</div>

		<div class="form-group col-sm-4">
			<label th:text="#{state}"></label>
			<input type="text" class="form-control" th:field="*{address.state}" data-parsley-maxlength="50" />
			<ul class="parsley-errors-list filled">
				<li class="parsley-required" th:errors="*{address.state}"></li>
			</ul>
		</div>

		<div class="form-group col-sm-4">
			<label th:text="#{zip.code}"></label>
			<input type="text" class="form-control" th:field="*{address.zipCode}" data-parsley-maxlength="10" />
			<ul class="parsley-errors-list filled">
				<li class="parsley-required" th:errors="*{address.zipCode}"></li>
			</ul>
		</div>
	</div>
    
    <!-- LOCK -->
    
	<div th:if="${(#request.requestURL.toString().contains(T(app.Routes).ADMIN_LOCK_EDIT))}" class="row" id="country-timezone">
		<input type="hidden" ref="AddressComp_countryIso2Ref" name="address.countryIso2" th:value="*{address.countryIso2}" :value="AddressComp_countryIso2Value"/>
		<input type="hidden" ref="AddressComp_countryUtcOffsetRef" name="address.countryUtcOffset" th:value="*{address.countryUtcOffset}" :value="AddressComp_countryUtcOffsetValue"/>
		
		<div class="col-md-12">

			<input type="hidden" ref="AddressComp_countryRef" th:value="*{address.countryName}" id="countryName">
			<div class="form-group">
				<label th:text="#{country}"></label>
				<vue-select2 class="form-control" name="address.countryName" :options="AddressComp_countries" :value="AddressComp_countrySelected"
					@input="AddressComp_countrySelected = $event" ref="AddressComp_countrySelectedRef" 
					data-parsley-required
                >
                </vue-select2>
				<ul class="parsley-errors-list filled">
					<li class="parsley-required" th:errors="*{address.countryName}"></li>
				</ul>
			</div>

		</div>


		<div class="col-md-6">

			<input type="hidden" ref="AddressComp_timezoneRef" th:value="*{address.countryTimeZone}" id="countryTimeZone">
			<div v-if="AddressComp_countrySelected != ''" class="form-group">
				<label th:text="#{time.zone}"></label>
				<vue-select2 class="form-control " id="selectTimeZone" name="address.countryTimeZone" th:data-placeholder="#{select}" :options="AddressComp_timezones"
					:value="AddressComp_timezoneSelected" ref="timezoneSelected" data-parsley-maxlength="50"
					@input="changeTimeZoneInput($event)"></vue-select2>
				<ul class="parsley-errors-list filled">
					<li class="parsley-required" th:errors="*{address.countryTimeZone}"></li>
				</ul>
			</div>
		</div>
	</div>
    
    <!-- EVERYONE ELSE --> 
    
    <div th:if="${!(#request.requestURL.toString().contains(T(app.Routes).ADMIN_LOCK_EDIT))}"  class="row" id="country-timezone">
        <input type="hidden" ref="AddressComp_countryIso2Ref" name="address.countryIso2" th:value="*{address.countryIso2}" :value="AddressComp_countryIso2Value"/>
		<input type="hidden" ref="AddressComp_countryUtcOffsetRef" name="address.countryUtcOffset" th:value="*{address.countryUtcOffset}" :value="AddressComp_countryUtcOffsetValue"/>
		
		<div class="col-md-12">

			<input type="hidden" ref="AddressComp_countryRef" th:value="*{address.countryName}" id="countryName">
			<div class="form-group">
				<label th:text="#{country}"></label>
				<vue-select2 class="form-control" name="address.countryName" :options="AddressComp_countries" :value="AddressComp_countrySelected"
					@input="AddressComp_countrySelected = $event" ref="AddressComp_countrySelectedRef" 
                >
                </vue-select2>
				<ul class="parsley-errors-list filled">
					<li class="parsley-required" th:errors="*{address.countryName}"></li>
				</ul>
			</div>

		</div>


		<div class="col-md-6 hide">

			<input type="hidden" ref="AddressComp_timezoneRef" th:value="*{address.countryTimeZone}" id="countryTimeZone">
			<div v-if="AddressComp_countrySelected != ''" class="form-group">
				<label th:text="#{time.zone}"></label>
				<vue-select2 class="form-control " id="selectTimeZone" name="address.countryTimeZone" th:data-placeholder="#{select}" :options="AddressComp_timezones"
					:value="AddressComp_timezoneSelected" ref="timezoneSelected" data-parsley-maxlength="50"
					@input="changeTimeZoneInput($event)"></vue-select2>
				<ul class="parsley-errors-list filled">
					<li class="parsley-required" th:errors="*{address.countryTimeZone}"></li>
				</ul>
			</div>
		</div>
	</div>
				
	<script th:inline="javascript">
		var VueAddressComponent = {};
		(function () {

			var elCountryName = $('#countryName');

			var selectText = [[#{ select }]];

			var countryDefaultValue = [[${object.address.countryName}]]
			
			var lockURL = [[@{${T(app.Routes).ADMIN_LOCK_EDIT}}]]

			var app = {
				data(){
					return {
						AddressComp_countries: null,
						AddressComp_timezones: null,
						AddressComp_countrySelected: '',
						AddressComp_timezoneSelected: '',
						AddressComp_countryIso2Value: '',
						AddressComp_countryUtcOffsetValue: '',
						AddressComp_countryRef: '',
						AddressComp_timezoneRef: '',
						AddressComp_countryIso2Ref: '',
						AddressComp_countryUtcOffsetRef: '',
						AddressComp_hasInitialCountry: false,
					}
					
				},
				methods: {
					changeTimeZoneInput(event){
						if(event != null && event != ''){
							this.AddressComp_timezoneSelected = event
						}
						
					},
					getTimezonesForCountry() {
						var countryId = CountryToTimeZone.getCountriesFromName(this.AddressComp_countrySelected)
						var timezonesObj = CountryToTimeZone.getTimezonesForCountry(countryId)
						var timezonesArray = []
						for (var i in timezonesObj) {
							var timezone = timezonesObj[i]
							timezonesArray.push({ id: timezone.name, text: timezone.name })
						}
						this.AddressComp_timezones = timezonesArray

						var hasTimezoneInTimezonesArray = timezonesArray.find((x)=>x.text==this.AddressComp_timezoneSelected) != null

						if ( timezonesArray.length > 0 
							&& (this.AddressComp_timezoneRef == "" || !hasTimezoneInTimezonesArray)){
							if (countryId == 'US') {
								this.AddressComp_timezoneSelected = timezonesArray[25]
							}else{
								this.AddressComp_timezoneSelected = timezonesArray[0]
							}
						}
						
					},
					setCountryIso2(){
						this.AddressComp_countryIso2Value = CountryToTimeZone.getCountriesFromName(this.AddressComp_countrySelected)
					},
					setCountryUtcOffset(){
						var timezone = this.AddressComp_timezoneSelected.text == null ? this.AddressComp_timezoneSelected : this.AddressComp_timezoneSelected.text
						this.AddressComp_countryUtcOffsetValue = CountryToTimeZone.getTimezone(timezone).utcOffsetStr
					},
				},
				watch: {
					AddressComp_countrySelected() {
					    if ($('#countryName').parsley().validate()) {
					        $('#countryName').parent().find('.parsley-required').remove();
					    }
					    
						if (this.AddressComp_countrySelected != null) {
							this.getTimezonesForCountry()
							this.setCountryIso2()
							if (window.location.pathname.includes(lockURL)) { 
    							$('#countryName').parent().removeClass('col-md-12');
								$('#countryName').parent().addClass('col-md-6');
						    } 
						}
					},
					AddressComp_timezoneSelected() {
						if (this.AddressComp_timezoneSelected != null && this.AddressComp_timezoneSelected != "") {
							this.setCountryUtcOffset()
						}
					},
				},
				beforeUpdate() {
					if (this.AddressComp_hasInitialCountry && this.AddressComp_countrySelected == "") {
						this.AddressComp_countrySelected = this.AddressComp_countryRef;
						this.AddressComp_timezoneSelected = this.AddressComp_timezoneRef;
						this.AddressComp_countryIso2Value = this.AddressComp_countryIso2Ref;
						this.AddressComp_countryUtcOffsetValue = this.AddressComp_countryUtcOffsetRef;
						this.AddressComp_hasInitialCountry = false;
					}
				},
				updated(){
					var selectedTimezone = $('#selectTimeZone').val();
					var timezone = this.AddressComp_timezoneSelected.text == null ? this.AddressComp_timezoneSelected : this.AddressComp_timezoneSelected.text

					if (this.AddressComp_countrySelected != ""
					    && timezone != selectedTimezone 
						&& timezone != ""){
						    this.AddressComp_timezoneSelected = timezone;
					}
				},
				mounted() {
					var countriesObj = CountryToTimeZone.getAllCountries()
					var countriesArray = [{ id: '', text: selectText, disabled: true }]
					for (var i in countriesObj) {
						var countryItem = countriesObj[i]
						countriesArray.push({ id: countryItem.name, text: countryItem.name })
					}
					this.AddressComp_countries = countriesArray
					this.AddressComp_countryRef = this.$refs.AddressComp_countryRef.value;
					this.AddressComp_timezoneRef = this.$refs.AddressComp_timezoneRef.value;
					this.AddressComp_countryIso2Ref = this.$refs.AddressComp_countryIso2Ref.value;
					this.AddressComp_countryUtcOffsetRef = this.$refs.AddressComp_countryUtcOffsetRef.value;
					if (this.AddressComp_countryRef != '') {
						this.AddressComp_countrySelected = this.AddressComp_countryRef;
						this.AddressComp_timezoneSelected = this.AddressComp_timezoneRef;
						this.AddressComp_countryIso2Value = this.AddressComp_countryIso2Ref;
						this.AddressComp_countryUtcOffsetValue = this.AddressComp_countryUtcOffsetValue;
						this.AddressComp_hasInitialCountry = true;
					}
				}
			}

			VueAddressComponent = app;
		})();
	</script>

</div>
