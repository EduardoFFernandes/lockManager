<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/_layout/main_layout}">

<div layout:fragment="content">

    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <h4 class="page-title float-left"
                    th:text="#{menu.lock.list}"></h4>

                <ol class="breadcrumb float-right">
                    <li class="breadcrumb-item"><a th:href="@{#}"
                        th:text="#{home}"></a></li>
                    <li class="breadcrumb-item active"
                        th:text="#{menu.lock.list}"></li>
                </ol>

                <div class="clearfix"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mt-4">
                <div class="card-body table-responsive">

                    <div class="row">
                        <div class="col-sm-12 col-md-11">
                            <h4 class="m-t-0 header-title mb-5"
                                th:text="#{menu.lock.list}"></h4>
                        </div>
                        <div
                            class="col-sm-12 col-md-1 text-right pr-4 btn-add">
                            <a th:href="@{/admin/lock/edit}"
                                class="tooltip-left"
                                th:title="#{lock.add}"> <i
                                class="ion ion-ios-add-circle"></i>
                            </a>
                        </div>
                    </div>

                    <table id="datatable"
                        class="table table-hover table-bordered">

                        <thead class="thead-light ">
                            <tr
                                th:if="${objects == null || objects?.isEmpty()}">
                                <th th:text="#{no.records.found}"></th>
                            </tr>
                            <tr th:if="${!objects?.isEmpty()}">
                                <th data-priority="1"
                                    th:text="#{serial.number}"></th>
                                <th th:text="#{client}"></th>
                                <th th:text="#{firmware.version}"></th>
                                <th th:text="#{model}"></th>
                                <th th:text="#{warehouse}"></th>
                                <th th:text="#{menu}" data-priority="2"
                                    class="actions">&nbsp;</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr th:each="object : ${objects}">
                                <td th:text="${object.serialNumber}"></td>
                                <td>
                                    <a 
                                    tabindex="0"
                                    th:text="${object.item?.purchase?.client} ? ${object.item.purchase.client.name} : ''"
                                    data-placement="auto"
                                    data-trigger="focus"
                                    class="link btn p-0 clientPopover"
                                    th:data-id="${object.id}"
                                    th:data-toggle="${object.item?.purchase?.client} ? 'popover' : ''"
                                    data-html="true"
                                    th:data-content="${object.item?.purchase?.client} ? 
                                    #{popover.client.content(
                                     ${object.item.purchase.client.email} ? ${object.item.purchase.client.email} : #{not.found},
                                      ${object.id},
                                       ${object.item.purchase.client.cellphone} ? ${object.item.purchase.client.cellphone} : #{not.found},
                                        ${object.item.purchase.client.identifier} ? ${object.item.purchase.client.identifier} : #{not.found})} : ''"
                                    th:title="${object.item?.purchase?.client} ? ${object.item.purchase.client.name} : ''">
                                    </a>
                                </td>
                                <td>
                                    <span th:if="${object.version}" 
                                        class="link btn p-0"
                                        th:attr="onclick=${'javascript: getReleaseNotes(' + object.version.id + ')'}" 
                                        th:text="${object.version.name}"></span>
                                </td>
                                <td
                                    th:text="${object.lockModel} ? ${object.lockModel.name} : ''"></td>
                                
                                <td
                                    th:text="${object.warehouse} ? ${object.warehouse.name} : ''"
                                    data-placement="auto"
                                    data-trigger="hover"
                                    th:data-toggle="${object.warehouse} ? 'popover' : ''"
                                    data-html="true"
                                    th:data-content="${object.warehouse} ? 
                                    #{popover.warehouse.content(${object.warehouse.address} ? ${object.warehouse.address} : #{not.found})} : ''"
                                    th:title="${object.warehouse} ? ${object.warehouse.name} : ''"></td>
                                <td
                                    class="actions lock-actions pb-0 pt-10">
                                    <a class="action-icon edit" href="#"
                                    role="button"
                                    th:data-id="${object.id}"
                                    onClick="javascript: showModal(this)">
                                        <i th:if="${object.item}"
                                        class="mdi mdi-pencil-box icon-resize"></i>
                                        <i th:if="!${object.item}"
                                        class="mdi mdi-plus-circle-outline icon-resize"></i>
                                </a> <a class="action-icon edit"
                                    data-toggle="dropdown" href="#"
                                    role="button"> <i
                                        class="mdi mdi-menu icon-resize"></i>
                                </a>
                                    <div
                                        class="dropdown-menu dropdown-menu-left profile-dropdown">
                                        <ul class="list-inline mb-0">
                                            <li
                                                class="dropdown notification-list">
                                                <a
                                                th:href="|@{/admin/lock/edit}/${object.id}|"
                                                class="dropdown-item notify-item pt-1 pb-1 action-icon edit">
                                                    <i
                                                    class="fas fa-edit font-size-16 tab-width"></i>
                                                    <span
                                                    th:text="#{edit}"></span>
                                            </a> <span
                                                class="checkAssociations"
                                                data-toggle="modal"
                                                data-target="#modalDeleteWarning">
                                                    <a
                                                    class="delete dropdown-item notify-item pt-1 pb-1 action-icon edit"
                                                    href="#"
                                                    th:data-url="@{/admin/lock/delete}"
                                                    th:data-id="${object.id}">
                                                        <i
                                                        class="far fa-trash-alt font-size-16 tab-width"></i><span
                                                        th:text="#{delete}"></span>
                                                </a>
                                            </span>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- end card-body -->
            </div>
            <!-- end card -->
        </div>
        <!-- end col -->
    </div>
    <!-- end row -->

    <script th:inline="javascript">
        var urlCheckAssociations = [[@{${T(brisa.lockmanager.Routes).API_EXISTS_LOCK_ASSOCIATIONS}}]]; // used in bottom.js
        $(function() {
            
            $('.clientPopover').on('shown.bs.popover', function () {
                var id = $(this).data('id')
                initI18nTelTd(id)
            })

            var columnsDefinitions = [ 
                { targets : [ 5 ], orderable : false } 
            ];

            if ([[${!objects?.isEmpty()}]]) {
                $('#datatable').DataTable(
                    buildDataTable(columnsDefinitions)
                );
            }
            
            $('#modalDeleteWarning').on('hidden.bs.modal', function () {
                $('#modalDeleteDesc').html([[#{message.warning.delete.desc}]]);
                $('#modalDeleteWarning').find(':submit').attr('disabled', false);
                $('#modalDeleteWarning').find(':submit').css('cursor', 'pointer');
            });
            
        });
        
        function showModal(object) {
        	var idLock = $(object).data('id') 
        	var lock = [[${objects}]].filter(x => x.id === idLock)[0]
        	$('#idLock').val(idLock);
        	if(lock.item) {
        	    debugger
	        	$('#idItem').val(lock.item.id);
	        	$('#price').val(Number(lock.item.price).toFixed(2));
	        	$('#sensor').prop("checked", lock.item.sensor);
	       		$('#installationLocation').val(lock.item.installationLocation);
	       		$('#notes').val(lock.item.notes);
	       		$('#status').val(lock.item.status).change(); 
	       		
	       		$('#deleteItemBtn').css('display', 'block');
	       		$('#modalDeleteWarning').css('zIndex', '9998');
	            $('#deleteId').val(lock.item.id);
	            $('#deleteForm').attr('action', [[@{${T(brisa.lockmanager.Routes).ADMIN_ITEM_DELETE}}]]);
                $('#modalAddItemLabel').html([[#{message.info.edit.item }]]);
        	} else {
        		$('#idItem').val(null);
	        	$('#price').val(Number(0).toFixed(2));
	        	$('#sensor').prop("checked", false);
	       		$('#installationLocation').val('');
	       		$('#notes').val('');
	       		$('#deleteItemBtn').css('display', 'none');
        	}
        	
        	$('#modalAddItem').css('zIndex', '1080');
        	$('#modalAddItem').modal('show')
        }
        
        function getReleaseNotes(id) {
            $.ajax({
                url: [[@{${T(brisa.lockmanager.Routes).API_RELEASE_NOTES}}]] + "/" + id,
                success: function(response) {
                    $('#releaseNotesTextarea').val(response.releaseNotes);
                    $('#releaseNotesModalLabel').html([[#{version}]] + ' ' + response.name);
                    $('#modalReleaseNotes').modal('show')
                }
            });
        }
        
    </script>
</div>

</html>
<style>
.tdPhone {
    border: 0px;
    background-color: transparent;
    padding-right: 0px !important;
    padding-left: 0px !important;
}

.iti {
    display: flex;
}

.iti__flag-container {
    position: inherit;
}
</style>
<!-- end fragment -->